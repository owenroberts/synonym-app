extends layout
block content
	div.error
		div.msg
			div.sorry= "We couldn't find a path."
			div.errormsg
			div.ok
				a="OK"
	div#hamburger
		ul
			li
				a(href="/")="New Search"
			li
				a(href="#")="About SynoPath"
	div#newpath
		ul
			li
				a(id="shortest" class="new" href="#")="Find Shortest Path"
			li
				a(id="longer" class="new" href="#")="Find Longer Path"
			li
				div.ldr
					img(src="/images/loader.svg")

	div#main
		header
			a.menu
				svg(width="22" height="22" viewBox="0 0 20 20" class="stroke")
					path(fill="none" stroke="#C7C8CA" stroke-width="2" stroke-linecap="round" d="M17.2 7.6H1.1M17.2 1.2H1.1M17.2 14H1.1")
			div.path-dots.fadein
				- var pathIndex = 0
				for result, index in data
					a.path-dot(id="p-"+index)
					- pathIndex = index
			a.plus.fadein
				svg(width="20" height="20" viewBox="0 0 20 20" class="stroke")
					g(fill="none")
					path(d="M9.6 1v17.1M18.1 9.6H1" stroke="#C7C8CA" stroke-width="2" stroke-linecap="round")
		div#paths
			for result, index in data
				div.path(id="path-"+index)
					div.nodes
						div.node-dad=result.start
							span.toggle
						each node, index in result.path
							div.node-dad
								span.toggle
									a.dots="•"
								div.inner-nodes
									div.node=node.node
									if node.alternates
										for alt in node.alternates
											if alt != node.node
												div.node.alternate=alt

						div.node-dad=result.end
							span.toggle
								

									
	// javascript // 
	script(type='text/javascript').

		$(document).ready( function() {

		function reportError(errmsg) {
			$('.error').fadeIn();
			$('.errormsg').html(errmsg);
			$('.ok').on('click', function() {
				$('.error').fadeOut();
			});
		}
		if ("#{errmsg}") reportError("#{errmsg}");

		// ** blogal variables ** //
		var w = window.innerWidth;
		var pathNum = #{pathIndex};
		var currentPathNum = pathNum;
		var pathData = !{JSON.stringify(data)};
		var modified = false;

		// ** animate nodes (or not) ** //
		if (pathNum < 1) {
			$('.path:first-child .nodes').animate({
			"padding-left":"16px"
			}, 900, function() {
				$('.toggle').animate({width:"26px"}, 900, function() {
					var nodes = $('.node-dad');
					for (var i = 0; i < nodes.length; i++) {
						var showNode = function(num) {
							setTimeout( function() {
								$(nodes[num]).fadeIn();
							}, num*400);
						}(i);
					}
				});
			});
			$('.path:gt(1) .nodes').css({
				'padding-left':'16px'
			});
			$('.path:gt(1) .toggle').css({width:'24px'});
			$('.path:gt(1) .node-dad').css({display:'block'});
		} else {
			$('.nodes').css({'padding-left':'16px'});
			$('.toggle').css({width:'26px'});
			$('.node-dad').css({display:'block'});
			$('.plus').css({transform:"rotate(45deg)"});
			setTimeout(function() {
				$('.plus').css({transform:"rotate(90deg)"});
			}, 500);
			$('.path-dot:nth-child('+(currentPathNum+1)+')').css({color:'black'});
			$('#paths').animate({
					left: -currentPathNum * w
			}, 500);
		}

		// ** fade in ui ** //
		$('.fadein').animate({
			opacity: 1
		}, 900);


		// ** position paths ** //
		var paths = $('.path');
		for (var i = 0; i < paths.length; i++) {
			$(paths[i]).css({left:i*w});
		}

		// ** animate path switching  ** //
		$('.path-dot').on('click', function() {
			$('.path-dot').css({color:'lightgray'});
			currentPathNum = $(this).index();
			$('.path-dot:nth-child('+(currentPathNum+1)+')').css({color:'black'});
			var index = $(this).index();
			$('#paths').animate({
				left: -w * index
			}, 500);
		});

		$( "header" ).on( "swipeleft", function() {
			if (currentPathNum < pathNum) {
				currentPathNum++;
				$('.path-dot').css({color:'lightgray'});
				$('.path-dot:nth-child('+(currentPathNum+1)+')').css({color:'black'});
				$('#paths').animate({
					left: -currentPathNum * w
				}, 500);
			}
		});

		$( "header" ).on( "swiperight", function() {
			if (currentPathNum > 0) {
				currentPathNum--;
				$('.path-dot').css({color:'lightgray'});
				$('.path-dot:nth-child('+(currentPathNum+1)+')').css({color:'black'});
				var offset = $('#paths').css('left');
				offset = offset.replace('px', '');
				$('#paths').animate({
					left: +offset + w
				}, 500);
			}
		});

		// ** plus button for new paths ** //
		function getNewPath(ev) {
			ev.stopPropagation();
			$('.ldr').fadeIn();

			var nodelimit;
			var synonymlevel;

			if ($(this).attr('id') == "shortest") {
				nodelimit = 1;
				synonymlevel = 10;
			} else {
				nodelimit = +pathData[currentPathNum].nodelimit + 1;
				synonymlevel = 10;
			}

			var form = $('<form>')
				.attr({
					"method":"get",
					"action":"/search",
					"id":"newpath"
				});
			var startElement = $("<input>")
				.attr({
					"name":"start",
					"value": pathData[currentPathNum].start
				});
			form.append(startElement);
			var endElement = $("<input>")
				.attr({
					"name":"end",
					"value": pathData[currentPathNum].end
				});
			form.append(endElement);
			var nodeElement = $("<input>")
				.attr({
					"name":"nodelimit",
					"value": nodelimit
				});
			form.append(nodeElement);
			var synElement = $("<input>")
				.attr({
					"name":"synonymlevel",
					"value": synonymlevel
				});
			form.append(synElement);
			for (var i = 0; i < data.length; i++){
				var pathElement = $("<input>")
					.attr({
						"name":"oldpath",
						"value": pathData[i].cname
					});
				form.append(pathElement);
			}
			console.log($(form));
			form.submit();			
		}

		$('.new').on('click', getNewPath);
		$('.plus').on('click', function() {
			$('#newpath').fadeIn();
		});
		$('#newpath').on('click', function() {
			$(this).fadeOut();
		});


		// ** hamburger menu ** //
		$('.menu').on('click', function() {
			$('#hamburger').fadeIn(500);
		});
		$('#hamburger').on('click', function() {
			$(this).fadeOut();
		});

		// ** inner nodes ** //
		var nodedads = $('.node-dad');
		for (var i = 1; i < nodedads.length - 1; i++) {
			var inner = $(this).find('.inner-nodes');
			var innerwidth = 0;
			var nodes = $(inner).find('.node');
			for (var h = 0; h < nodes.length; h++) {
				innerwidth += $(nodes[i]).width();
			}
			$(inner).css({width:innerwidth});
			$(nodedads[i]).css({width:innerwidth + 48});
		}


		// ** swipe left on nodes ** //
		$( 'body' ).on( "swipeleft", ".node", function() {
			if (!modified) {
				modified = true;
				var alt = $(this).next();
				if (alt[0]) {
					var parent = $(this).parent();
					var alt = $(this).next();
					$(this).animate({
						opacity: 0
					}, 500);
					$(alt).animate({
						opacity: 1
					}, 500);
					$(parent).animate({
						left: "-=300"
					}, 500);
					modifyChain($(parent).parent(), $(alt)[0].innerText);
				} else {
					reportError('This is the last alternative synonym.');
				}
			}
			
		});

		// ** swipe right on nodes ** //
		$( 'body' ).on( "swiperight", ".node", function() {
			if (!modified) {
				modified = true;
				var alt = $(this).prev();
				if (alt[0]) {
					var parent = $(this).parent();
					var alt = $(this).prev();
					$(this).animate({
						opacity: 0
					}, 500);
					$(alt).animate({
						opacity: 1
					}, 500);
					$(parent).animate({
						left: "+=300"
					}, 500);
					modifyChain($(parent).parent(), $(alt)[0].innerText);
				} else {
					reportError('This is the first alternative synonym.');
				}
			}
			
		});
		
		// ** modify chain ** //
		function modifyChain(elem, alt) {
			$(elem).find('.dots').html('<img src="/images/loader.svg" />');
			
			var pathIndex = $(elem).index();
			var pathParent = $(elem).parent().parent().attr('id');
			var nodes = $('#' + pathParent + ' .node-dad:gt('+elem.index()+')');

			$(nodes).animate({
				opacity: 0.3
			}, 300);

			var allsynonyms = [pathData[currentPathNum].start];

			for (var i = 0; i < pathIndex; i++) {
				allsynonyms = allsynonyms.concat(pathData[currentPathNum].path[i].alternates);
			}

			$.ajax({
				url: '/search/modified',
				type: 'get',
				dataType:'json',
				data: {
					start: alt,
					end: pathData[currentPathNum].end,
					synonymlevel: 10,
					nodelimit: 10 - elem.index(),
					allsynonyms: allsynonyms
				},
				success: function(data) {

					console.log("done");
					
					
					if (data.errormsg) {
						var err = '"' + alt + '" is related to "' + pathData[currentPathNum].start + '," but we couldn\'t find a path that connects it to "' + pathData[currentPathNum].end + '." <br><br> You can either swipe back to the previous word or try another one.';
						console.log(err);
						reportError(err);
						$(nodes).animate({
							opacity: 1
						}, 300, function() {
							modified = false;
						});
						$(elem).find('.dots').html('•');

					} else {
						$(nodes).animate({
							opacity: 1
						}, 300);

						var waitTime = nodes.length * 300;

						for (var i = 0; i < nodes.length - 1; i++) {
							var n = i;
							$(nodes[i]).fadeOut((nodes.length - i) * 300, function(n) {
								this.remove();
							});
						}

						for (var i = 0; i < data.path.length; i ++) {
							var newnodedad = $('<div>')
								.addClass('node-dad');
							var newtoggle = $('<span>')
								.addClass('toggle')
								.css({width:'24px'});
							var newdots = $('<a>')
								.addClass('dots')
								.text('•');
							newtoggle.append(newdots);
							
							var inners = $('<div>')
								.addClass('inner-nodes');

							var newnode = $('<div>')
								.addClass('node')
								.text(data.path[i].node);

							newnodedad.append(newtoggle);
							inners.append(newnode);
							for (var h = 0; h < data.path[i].alternates.length; h++) {
								if (data.path[i].alternates[h] != data.path[i].node) {
									var newsynnode = $('<div>')
										.addClass('node')
										.addClass('alternate')
										.text(data.path[i].alternates[h]);
										inners.append(newsynnode);
								}
							}
							
							newnodedad.append(inners);
							newnodedad.insertBefore('#' + pathParent + ' .node-dad:last-child()');
							newnodedad.delay(i * 500 + waitTime + 500).fadeIn(500);
							setTimeout(function() {
								$(elem).find('.dots').html('•');
								modified = false;
							}, waitTime);
						}
					}
				}
			});
		}
		});